---
import { sql } from '../lib/db';

// Fetch homepage sections from Neon database
const sections = await sql`
  SELECT section_type, content
  FROM homepage_content
  WHERE site = 'rainmakrr'
  ORDER BY section_order
`;

// Convert to object for easy access
const content: Record<string, any> = {};
sections.forEach((section: any) => {
  content[section.section_type] = section.content;
});

// Fetch latest startup news articles
const latestArticles = await sql`
  SELECT
    a.id,
    a.title,
    a.excerpt,
    a.slug,
    a.published_at,
    a.created_at,
    a.images,
    (
      SELECT json_build_object('url', i.cloudinary_url, 'alt', aiu.alt_text)
      FROM article_image_usage aiu
      JOIN images i ON i.id = aiu.image_id
      WHERE aiu.article_id = a.id AND aiu.role = 'featured'
      LIMIT 1
    ) as featured_image_legacy
  FROM articles a
  WHERE a.app = 'rainmakrr'
    AND a.status = 'published'
  ORDER BY a.published_at DESC NULLS LAST, a.created_at DESC
  LIMIT 6
`;
---

<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{content.hero?.title || 'StartUp News UK - Rainmakwr'}</title>
  <meta name="description" content={content.hero?.subtitle || 'Your source for the latest UK startup news, funding announcements, and entrepreneurship insights'}>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-purple-600">
            <a href="/">Rainmakwr</a>
          </h1>
        </div>
        <div class="flex items-center space-x-8">
          <a href="/" class="text-gray-700 hover:text-purple-600 font-medium">Home</a>
          <a href="/articles" class="text-gray-700 hover:text-purple-600 font-medium">News</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  {content.hero && (
    <section class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <h1 class="text-5xl md:text-6xl font-bold mb-6">{content.hero.title}</h1>
          <p class="text-xl md:text-2xl mb-8 text-purple-100">{content.hero.subtitle}</p>
          <a href="/articles" class="inline-block bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-colors">
            Read Latest News
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- Introduction -->
  {content.intro && (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="prose prose-lg max-w-none">
          <h2 class="text-3xl font-bold text-gray-900 mb-6">{content.intro.heading}</h2>
          <p class="text-gray-700 text-lg leading-relaxed">{content.intro.text}</p>
        </div>
      </div>
    </section>
  )}

  <!-- Latest News Articles -->
  {latestArticles.length > 0 && (
    <section class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Latest StartUp News</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {latestArticles.map((article: any) => (
            <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
              {(article.images?.featured || article.featured_image_legacy?.url) && (
                <img src={article.images?.featured || article.featured_image_legacy.url} alt={article.featured_image_legacy?.alt || article.title} class="w-full h-48 object-cover" />
              )}
              <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-3 line-clamp-2">
                  <a href={`/${article.slug}`} class="hover:text-purple-600">
                    {article.title}
                  </a>
                </h3>
                {article.excerpt && (
                  <p class="text-gray-600 mb-4 line-clamp-3">
                    {article.excerpt}
                  </p>
                )}
                <div class="flex items-center justify-between text-sm text-gray-500">
                  <time datetime={article.published_at || article.created_at}>
                    {new Date(article.published_at || article.created_at).toLocaleDateString('en-GB', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </time>
                  <a href={`/${article.slug}`} class="text-purple-600 hover:text-purple-800 font-medium">
                    Read more →
                  </a>
                </div>
              </div>
            </article>
          ))}
        </div>
        <div class="text-center mt-12">
          <a href="/articles" class="inline-block bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
            View All News
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- UK StartUp Ecosystem -->
  {content.ecosystem && (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">{content.ecosystem.heading}</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {content.ecosystem.stats.map((stat: any) => (
            <div class="text-center p-6 bg-purple-50 rounded-lg">
              <div class="text-4xl font-bold text-purple-600 mb-2">{stat.value}</div>
              <div class="text-gray-700">{stat.label}</div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Trending Topics -->
  {content.topics && (
    <section class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">{content.topics.heading}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {content.topics.list.map((topic: any) => (
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 class="text-xl font-bold text-gray-900 mb-3">{topic.name}</h3>
              <p class="text-gray-700">{topic.description}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Growth Sectors -->
  {content.sectors && (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">{content.sectors.heading}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {content.sectors.list.map((sector: any) => (
            <div class="bg-purple-50 p-6 rounded-lg text-center">
              <div class="text-3xl mb-3">{sector.icon}</div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">{sector.name}</h3>
              <p class="text-sm text-gray-600">{sector.growth}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Regional Hubs -->
  {content.regions && (
    <section class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">{content.regions.heading}</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {content.regions.list.map((region: any) => (
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h3 class="text-xl font-bold text-gray-900 mb-3">{region.name}</h3>
              <p class="text-gray-700 mb-2">{region.description}</p>
              <p class="text-sm text-purple-600 font-semibold">{region.startups}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Success Stories -->
  {content.success && (
    <section class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">{content.success.heading}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {content.success.stories.map((story: any) => (
            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-8 rounded-lg">
              <h3 class="text-2xl font-bold text-gray-900 mb-3">{story.company}</h3>
              <p class="text-gray-700 mb-4">{story.description}</p>
              <div class="flex items-center justify-between text-sm">
                <span class="text-purple-600 font-semibold">{story.sector}</span>
                <span class="text-gray-600">{story.achievement}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- How to Stay Updated -->
  {content.howTo && (
    <section class="py-16 bg-gray-50">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">{content.howTo.heading}</h2>
        <div class="space-y-6">
          {content.howTo.steps.map((step: any, index: number) => (
            <div class="bg-white p-6 rounded-lg shadow-sm flex items-start">
              <div class="flex-shrink-0 bg-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold mr-4">
                {index + 1}
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">{step.title}</h3>
                <p class="text-gray-700">{step.description}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- FAQ -->
  {content.faq && (
    <section class="py-16 bg-white">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Frequently Asked Questions</h2>
        <div class="space-y-6">
          {content.faq.questions.map((item: any) => (
            <div class="bg-gray-50 p-6 rounded-lg">
              <h3 class="text-lg font-semibold text-gray-900 mb-3">{item.question}</h3>
              <p class="text-gray-700">{item.answer}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">© {new Date().getFullYear()} Rainmakwr. All rights reserved.</p>
    </div>
  </footer>
</body>
</html>
